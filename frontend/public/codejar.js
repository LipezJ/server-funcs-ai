let globalWindow=window;export function CodeJar(e,t,n={}){let r=Object.assign({tab:"	",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:globalWindow},n),i=r.window,o=i.document,l=[],s=[],d=-1,a=!1,f,u;e.setAttribute("contenteditable","plaintext-only"),e.setAttribute("spellcheck",r.spellcheck?"true":"false"),e.style.outline="none",e.style.overflowWrap="break-word",e.style.overflowY="auto",e.style.whiteSpace="pre-wrap";let c=!1;t(e),"plaintext-only"!==e.contentEditable&&(c=!0),c&&e.setAttribute("contenteditable","true");let p=L(()=>{let n=C();t(e,n),T(n)},30),g=!1,h=e=>!x(e)&&!w(e)&&"Meta"!==e.key&&"Control"!==e.key&&"Alt"!==e.key&&!e.key.startsWith("Arrow"),$=L(e=>{h(e)&&(N(),g=!1)},300),y=(t,n)=>{l.push([t,n]),e.addEventListener(t,n)};function C(){let t=S(),n={start:0,end:0,dir:void 0},{anchorNode:r,anchorOffset:i,focusNode:l,focusOffset:s}=t;if(!r||!l)throw"error1";if(r===e&&l===e)return n.start=i>0&&e.textContent?e.textContent.length:0,n.end=s>0&&e.textContent?e.textContent.length:0,n.dir=s>=i?"->":"<-",n;if(r.nodeType===Node.ELEMENT_NODE){let d=o.createTextNode("");r.insertBefore(d,r.childNodes[i]),r=d,i=0}if(l.nodeType===Node.ELEMENT_NODE){let a=o.createTextNode("");l.insertBefore(a,l.childNodes[s]),l=a,s=0}return m(e,e=>{if(e===r&&e===l)return n.start+=i,n.end+=s,n.dir=i<=s?"->":"<-","stop";if(e===r){if(n.start+=i,n.dir)return"stop";n.dir="->"}else if(e===l){if(n.end+=s,n.dir)return"stop";n.dir="<-"}e.nodeType===Node.TEXT_NODE&&("->"!=n.dir&&(n.start+=e.nodeValue.length),"<-"!=n.dir&&(n.end+=e.nodeValue.length))}),e.normalize(),n}function T(t){let n=S(),r,i=0,o,l=0;if(t.dir||(t.dir="->"),t.start<0&&(t.start=0),t.end<0&&(t.end=0),"<-"==t.dir){let{start:s,end:d}=t;t.start=d,t.end=s}let a=0;m(e,e=>{if(e.nodeType!==Node.TEXT_NODE)return;let n=(e.nodeValue||"").length;if(a+n>t.start&&(r||(r=e,i=t.start-a),a+n>t.end))return o=e,l=t.end-a,"stop";a+=n}),r||(r=e,i=e.childNodes.length),o||(o=e,l=e.childNodes.length),"<-"==t.dir&&([r,i,o,l]=[o,l,r,i]),n.setBaseAndExtent(r,i,o,l)}function b(){let t=S(),n=t.getRangeAt(0),r=o.createRange();return r.selectNodeContents(e),r.setEnd(n.startContainer,n.startOffset),r.toString()}function E(){let t=S(),n=t.getRangeAt(0),r=o.createRange();return r.selectNodeContents(e),r.setStart(n.endContainer,n.endOffset),r.toString()}function k(e){if(c&&"Enter"===e.key){if(M(e),e.stopPropagation(),""==E()){O("\n ");let t=C();t.start=--t.end,T(t)}else O("\n")}}function N(){if(!a)return;let t=e.innerHTML,n=C(),r=s[d];(!r||r.html!==t||r.pos.start!==n.start||r.pos.end!==n.end)&&(s[++d]={html:t,pos:n},s.splice(d+1),d>300&&(d=300,s.splice(0,1)))}function m(e,t){let n=[];e.firstChild&&n.push(e.firstChild);let r=n.pop();for(;r&&"stop"!==t(r);)r.nextSibling&&n.push(r.nextSibling),r.firstChild&&n.push(r.firstChild),r=n.pop()}function v(e){return e.metaKey||e.ctrlKey}function x(e){return v(e)&&!e.shiftKey&&"Z"===_(e)}function w(e){return v(e)&&e.shiftKey&&"Z"===_(e)}function _(e){let t=e.key||e.keyCode||e.which;if(t)return("string"==typeof t?t:String.fromCharCode(t)).toUpperCase()}function O(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),o.execCommand("insertHTML",!1,e)}function L(e,t){let n=0;return(...r)=>{clearTimeout(n),n=i.setTimeout(()=>e(...r),t)}}function A(e){let t=e.length-1;for(;t>=0&&"\n"!==e[t];)t--;let n=++t;for(;n<e.length&&/[ \t]/.test(e[n]);)n++;return[e.substring(t,n)||"",t,n]}function D(){return e.textContent||""}function M(e){e.preventDefault()}function S(){var t;return(null===(t=e.parentNode)||void 0===t?void 0:t.nodeType)==Node.DOCUMENT_FRAGMENT_NODE?e.parentNode.getSelection():i.getSelection()}return y("keydown",t=>{var n;t.defaultPrevented||(u=D(),r.preserveIdent?function e(t){if("Enter"===t.key){let n=b(),i=E(),[o]=A(n),l=o;if(r.indentOn.test(n)&&(l+=r.tab),l.length>0?(M(t),t.stopPropagation(),O("\n"+l)):k(t),l!==o&&r.moveToNewLine.test(i)){let s=C();O("\n"+o),T(s)}}}(t):k(t),r.catchTab&&function e(t){if("Tab"===t.key){if(M(t),t.shiftKey){let n=b(),[i,l,]=A(n);if(i.length>0){let s=C(),d=Math.min(r.tab.length,i.length);T({start:l,end:l+d}),o.execCommand("delete"),s.start-=d,s.end-=d,T(s)}}else O(r.tab)}}(t),r.addClosing&&function e(t){let n="([{'\"",r=")]}'\"",i=E(),o=b(),l="\\"===o.substr(o.length-1),s=i.substr(0,1);if(r.includes(t.key)&&!l&&s===t.key){let d=C();M(t),d.start=++d.end,T(d)}else if(n.includes(t.key)&&!l&&("\"'".includes(t.key)||[""," ","\n"].includes(s))){M(t);let a=C(),f=a.start==a.end?"":S().toString(),u=t.key+f+r[n.indexOf(t.key)];O(u),a.start++,a.end++,T(a)}}(t),r.history&&(function t(n){if(x(n)){M(n),d--;let r=s[d];r&&(e.innerHTML=r.html,T(r.pos)),d<0&&(d=0)}if(w(n)){M(n),d++;let i=s[d];i&&(e.innerHTML=i.html,T(i.pos)),d>=s.length&&d--}}(t),h(t)&&!g&&(N(),g=!0)),c&&(n=t,!v(n)||"C"!==_(n))&&T(C()))}),y("keyup",e=>{!e.defaultPrevented&&!e.isComposing&&(u!==D()&&p(),$(e),f&&f(D()))}),y("focus",e=>{a=!0}),y("blur",e=>{a=!1}),y("paste",n=>{N(),function n(r){M(r);let i=(r.originalEvent||r).clipboardData.getData("text/plain").replace(/\r/g,""),o=C();O(i),t(e),T({start:Math.min(o.start,o.end)+i.length,end:Math.min(o.start,o.end)+i.length,dir:"<-"})}(n),N(),f&&f(D())}),{updateOptions(e){Object.assign(r,e)},updateCode(n){e.textContent=n,t(e)},onUpdate(e){f=e},toString:D,save:C,restore:T,recordHistory:N,destroy(){for(let[t,n]of l)e.removeEventListener(t,n)}}}